from IPython.display import display, HTML

display(HTML("""
<div style="font-family: Arial; padding: 14px; max-width: 1100px; margin:auto; border:1px solid #ddd; border-radius:10px;">
  <h2 style="margin:0;">EMAPALA EP â€“ Panel Operativo (Demo SCADA)</h2>
  <p style="margin-top:6px; color:#444;">
    Monitoreo simulado de bombas, niveles, consumo, operadores y alarmas (Google Colab compatible).
  </p>

  <!-- Barra superior -->
  <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;">
    <div style="flex:1; min-width:240px; padding:10px; border:1px solid #eee; border-radius:8px;">
      <b>ðŸ•’ Hora</b><br>
      <span id="clock">--:--:--</span>
    </div>
    <div style="flex:1; min-width:240px; padding:10px; border:1px solid #eee; border-radius:8px;">
      <b>ðŸ“¶ Estado de comunicaciÃ³n</b><br>
      <span id="comm">OK</span>
    </div>
    <div style="flex:1; min-width:240px; padding:10px; border:1px solid #eee; border-radius:8px;">
      <b>ðŸš¨ Alarmas activas</b><br>
      <span id="alarmCount">0</span>
    </div>
    <div style="flex:1; min-width:240px; padding:10px; border:1px solid #eee; border-radius:8px;">
      <b>âš¡ EnergÃ­a total (kWh)</b><br>
      <span id="totalEnergy">0.00</span>
    </div>
  </div>

  <!-- Operadores -->
  <h3 style="margin-top:18px;">ðŸ‘· Operadores</h3>
  <div id="operators" style="padding:10px; border:1px solid #eee; border-radius:8px;"></div>

  <!-- Bombas -->
  <h3 style="margin-top:18px;">ðŸ’§ Bombas / Captaciones</h3>
  <div id="pumps" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:10px;"></div>

  <!-- Niveles -->
  <h3 style="margin-top:18px;">ðŸ“Š Niveles (Tanque / Pozos)</h3>
  <div id="levels" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:10px;"></div>

  <!-- Alarmas -->
  <h3 style="margin-top:18px;">ðŸš¨ Alarmas</h3>
  <div id="alarms" style="padding:10px; border:1px solid #eee; border-radius:8px; background:#fff;"></div>

  <!-- BitÃ¡cora -->
  <h3 style="margin-top:18px;">ðŸ§¾ BitÃ¡cora (Eventos)</h3>
  <div id="log" style="height:220px; overflow:auto; padding:10px; border:1px solid #eee; border-radius:8px; background:#fafafa;"></div>

  <hr style="margin:18px 0; border:none; border-top:1px solid #eee;">
  <p style="color:#666; font-size:12px; margin:0;">
    Demo para fines de visualizaciÃ³n. Para datos reales: integrar con API / SCADA / PLC (Modbus, MQTT, etc.).
  </p>
</div>

<script>
/* ===========================
   1) DATOS (SIMULADOS)
=========================== */
const operators = [
  {name:"Carlos Mera", role:"Operador de Planta", shift:"06:00â€“14:00"},
  {name:"Diana LÃ³pez", role:"Operadora de Turno", shift:"14:00â€“22:00"},
  {name:"JosÃ© Paredes", role:"TÃ©cnico ElectromecÃ¡nico", shift:"Guardia"}
];

let pumps = [
  {id:"PZ1", name:"Pozo 1", status:"OFF", kw:0.0, energy:0.0, wellLevel:70, tankLevel:60, fault:false},
  {id:"PZ2", name:"Pozo 2", status:"ON",  kw:7.5, energy:0.0, wellLevel:55, tankLevel:60, fault:false},
  {id:"PZ3", name:"Pozo 3", status:"OFF", kw:0.0, energy:0.0, wellLevel:40, tankLevel:60, fault:false},
  {id:"PZ4", name:"Pozo 4", status:"ON",  kw:8.2, energy:0.0, wellLevel:65, tankLevel:60, fault:false},
];

let plant = {
  tankLevel: 60,   // % tanque principal
  commOk: true,
  totalEnergy: 0.0,
};

let alarms = [];   // {time, type, msg}
let logLines = []; // strings

/* ===========================
   2) UTILIDADES UI
=========================== */
function nowStr(){
  const d = new Date();
  return d.toLocaleString();
}

function pushLog(msg){
  const line = "â€¢ [" + nowStr() + "] " + msg;
  logLines.unshift(line);
  if (logLines.length > 120) logLines.pop();
}

function addAlarm(type, msg){
  const a = {time: nowStr(), type, msg};
  alarms.unshift(a);
  if (alarms.length > 50) alarms.pop();
}

function clearAlarm(type, containsText){
  alarms = alarms.filter(a => !(a.type === type && a.msg.includes(containsText)));
}

function badge(text, bg){
  return `<span style="display:inline-block; padding:2px 8px; border-radius:999px; background:${bg}; color:#fff; font-size:12px;">${text}</span>`;
}

function statusBadge(p){
  if (p.fault) return badge("FALLA", "#d32f2f");
  if (p.status === "ON") return badge("ON", "#2e7d32");
  return badge("OFF", "#616161");
}

function bar(label, value){
  const v = Math.max(0, Math.min(100, value));
  return `
    <div style="margin-top:6px;">
      <div style="display:flex; justify-content:space-between; font-size:12px; color:#444;">
        <span>${label}</span><b>${v.toFixed(0)}%</b>
      </div>
      <div style="height:10px; background:#eee; border-radius:999px; overflow:hidden;">
        <div style="height:10px; width:${v}%; background:#1976d2;"></div>
      </div>
    </div>`;
}

/* ===========================
   3) RENDER
=========================== */
function renderOperators(){
  let html = `<table style="width:100%; border-collapse:collapse;">
    <tr style="text-align:left;">
      <th style="border-bottom:1px solid #eee; padding:6px;">Nombre</th>
      <th style="border-bottom:1px solid #eee; padding:6px;">Cargo</th>
      <th style="border-bottom:1px solid #eee; padding:6px;">Turno</th>
    </tr>`;
  operators.forEach(o=>{
    html += `<tr>
      <td style="border-bottom:1px solid #f2f2f2; padding:6px;">${o.name}</td>
      <td style="border-bottom:1px solid #f2f2f2; padding:6px;">${o.role}</td>
      <td style="border-bottom:1px solid #f2f2f2; padding:6px;">${o.shift}</td>
    </tr>`;
  });
  html += `</table>`;
  document.getElementById("operators").innerHTML = html;
}

function renderPumps(){
  let html = "";
  pumps.forEach(p=>{
    const kwText = (p.status === "ON" && !p.fault) ? p.kw.toFixed(1) : "0.0";
    html += `
      <div style="padding:10px; border:1px solid #eee; border-radius:8px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <b>${p.name}</b>
          ${statusBadge(p)}
        </div>
        <div style="margin-top:6px; color:#333;">
          <div>âš¡ Potencia: <b>${kwText} kW</b></div>
          <div>ðŸ”‹ EnergÃ­a: <b>${p.energy.toFixed(2)} kWh</b></div>
        </div>
        ${bar("Nivel de pozo", p.wellLevel)}
        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:10px;">
          <button onclick="turnOn('${p.id}')" style="padding:6px 10px;">Encender</button>
          <button onclick="turnOff('${p.id}')" style="padding:6px 10px;">Apagar</button>
          <button onclick="toggleFault('${p.id}')" style="padding:6px 10px;">Simular falla</button>
          <button onclick="resetFault('${p.id}')" style="padding:6px 10px;">Reset</button>
        </div>
      </div>`;
  });
  document.getElementById("pumps").innerHTML = html;
}

function renderLevels(){
  let html = `
    <div style="padding:10px; border:1px solid #eee; border-radius:8px;">
      <b>Tanque principal (Planta)</b>
      ${bar("Nivel de tanque", plant.tankLevel)}
      <div style="margin-top:6px; color:#444; font-size:12px;">
        (Regla demo: si tanque &lt; 35% â†’ alarmas y recomendaciÃ³n de encendido)
      </div>
    </div>
  `;

  pumps.forEach(p=>{
    html += `
      <div style="padding:10px; border:1px solid #eee; border-radius:8px;">
        <b>${p.name} â€“ Niveles</b>
        ${bar("Nivel de pozo", p.wellLevel)}
        ${bar("Nivel de tanque (referencia)", plant.tankLevel)}
      </div>`;
  });

  document.getElementById("levels").innerHTML = html;
}

function renderAlarms(){
  document.getElementById("alarmCount").innerText = alarms.length;
  if (alarms.length === 0){
    document.getElementById("alarms").innerHTML = "âœ… Sin alarmas activas.";
    return;
  }
  let html = "<ul style='margin:0; padding-left:18px;'>";
  alarms.forEach(a=>{
    html += `<li><b>${a.type}</b> â€“ ${a.msg} <span style="color:#777; font-size:12px;">(${a.time})</span></li>`;
  });
  html += "</ul>";
  document.getElementById("alarms").innerHTML = html;
}

function renderLog(){
  document.getElementById("log").innerHTML = logLines.map(x=>`<div>${x}</div>`).join("");
}

function renderTop(){
  document.getElementById("clock").innerText = new Date().toLocaleTimeString();
  document.getElementById("comm").innerHTML = plant.commOk ? badge("OK", "#2e7d32") : badge("FALLA", "#d32f2f");
  document.getElementById("totalEnergy").innerText = plant.totalEnergy.toFixed(2);
}

/* ===========================
   4) CONTROLES (BOTONES)
=========================== */
function findPump(id){ return pumps.find(p=>p.id===id); }

function turnOn(id){
  const p = findPump(id);
  if (!p) return;
  if (p.fault){
    addAlarm("BOMBA", `${p.name} no puede encender: estÃ¡ en FALLA.`);
    pushLog(`Intento de encendido fallido: ${p.name} (FALLA).`);
  } else {
    p.status = "ON";
    p.kw = Math.max(5.5, p.kw); // asegura un valor
    pushLog(`Encendida ${p.name}.`);
    clearAlarm("BOMBA", p.name);
  }
  renderAll();
}

function turnOff(id){
  const p = findPump(id);
  if (!p) return;
  p.status = "OFF";
  p.kw = 0.0;
  pushLog(`Apagada ${p.name}.`);
  renderAll();
}

function toggleFault(id){
  const p = findPump(id);
  if (!p) return;
  p.fault = !p.fault;
  if (p.fault){
    p.status = "OFF";
    p.kw = 0.0;
    addAlarm("FALLA", `${p.name} reporta condiciÃ³n de falla.`);
    pushLog(`Falla simulada en ${p.name}.`);
  } else {
    pushLog(`Se retirÃ³ condiciÃ³n de falla en ${p.name}.`);
    clearAlarm("FALLA", p.name);
  }
  renderAll();
}

function resetFault(id){
  const p = findPump(id);
  if (!p) return;
  p.fault = false;
  pushLog(`Reset aplicado a ${p.name}.`);
  clearAlarm("FALLA", p.name);
  renderAll();
}

/* ===========================
   5) SIMULACIÃ“N (TIEMPO REAL)
=========================== */
function simulateStep(){
  // 1) comunicaciÃ³n (simula microcortes muy raros)
  if (Math.random() < 0.02){
    plant.commOk = false;
    addAlarm("COMMS", "PÃ©rdida temporal de comunicaciÃ³n (enlace inalÃ¡mbrico).");
    pushLog("Alerta de comunicaciÃ³n (simulada).");
  } else {
    plant.commOk = true;
    clearAlarm("COMMS", "comunicaciÃ³n");
  }

  // 2) tanque sube/baja segÃºn bombas ON
  const onCount = pumps.filter(p=>p.status==="ON" && !p.fault).length;
  plant.tankLevel += (onCount * 0.6) - 0.8; // consumo base
  plant.tankLevel = Math.max(0, Math.min(100, plant.tankLevel));

  // 3) pozo baja si bomba ON; se recupera lento si OFF
  pumps.forEach(p=>{
    if (p.status==="ON" && !p.fault){
      p.wellLevel -= (0.8 + Math.random()*0.6);
      // energÃ­a: kW * (2s / 3600)
      const stepHours = 2/3600;
      const kw = p.kw + (Math.random()*0.8 - 0.4);
      p.energy += Math.max(0, kw) * stepHours;
    } else {
      p.wellLevel += 0.2 + Math.random()*0.3;
    }
    p.wellLevel = Math.max(0, Math.min(100, p.wellLevel));
  });

  // 4) energÃ­a total
  plant.totalEnergy = pumps.reduce((acc,p)=>acc+p.energy, 0);

  // 5) reglas de alarmas
  if (plant.tankLevel < 35){
    addAlarm("NIVEL", "Nivel bajo en tanque principal (<35%). Recomendado encender bombas.");
  } else {
    clearAlarm("NIVEL", "Nivel bajo");
  }

  pumps.forEach(p=>{
    if (p.wellLevel < 20){
      addAlarm("NIVEL", `${p.name}: Nivel bajo de pozo (<20%). Evitar operaciÃ³n en vacÃ­o.`);
      if (p.status==="ON"){
        p.status="OFF";
        p.kw=0.0;
        pushLog(`ProtecciÃ³n: ${p.name} apagada por nivel bajo (evitar vacÃ­o).`);
      }
    } else {
      clearAlarm("NIVEL", p.name);
    }
  });

  renderAll();
}

/* ===========================
   6) RENDER GLOBAL
=========================== */
function renderAll(){
  renderTop();
  renderOperators();
  renderPumps();
  renderLevels();
  renderAlarms();
  renderLog();
}

/* ===========================
   7) INICIO
=========================== */
pushLog("Sistema iniciado (demo).");
renderAll();
setInterval(simulateStep, 2000);
</script>
"""))
